async def handle_user_registration(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    try:
        user_id = update.effective_user.id
        message_text = update.message.text

        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø© - Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ Ø£ÙˆÙ„Ø§Ù‹ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬
        if context.user_data.get('awaiting_wallet'):
            await handle_wallet_address(update, context)
            return

        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        if context.user_data.get('awaiting_registration'):
            lines = message_text.strip().split('\n')
            if len(lines) >= 3:
                name = lines[0].strip()
                phone = lines[1].strip()
                country = lines[2].strip()

                # Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                conn = sqlite3.connect('trading_bot.db')
                c = conn.cursor()
                c.execute('''
                    INSERT OR REPLACE INTO users
                    (user_id, username, full_name, phone, country, balance, registration_date)
                    VALUES (?, ?, ?, ?, ?, 0, datetime('now'))
                ''', (user_id, update.effective_user.username, name, phone, country))
                conn.commit()
                conn.close()

                # Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                del context.user_data['awaiting_registration']

                await update.message.reply_text(
                    f"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ Ø¨Ù†Ø¬Ø§Ø­!\n\n"
                    f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {name}\n"
                    f"ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: {phone}\n"
                    f"ğŸŒ Ø§Ù„Ø¨Ù„Ø¯: {country}\n\n"
                    f"ğŸš€ Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„!"
                )

                # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø¹ Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ù‚Ù†Ø§Ø©
                await send_admin_notification(
                    f"ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:\n"
                    f"Ø§Ù„Ø§Ø³Ù…: {name}\n"
                    f"Ø§Ù„Ù‡Ø§ØªÙ: {phone}\n"
                    f"Ø§Ù„Ø¨Ù„Ø¯: {country}\n"
                    f"ID: {user_id}\n"
                    f"@{update.effective_user.username or 'Ø¨Ø¯ÙˆÙ†'}"
                )
            else:
                await update.message.reply_text(
                    "âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©:\n\n"
                    "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ\nØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\nØ§Ù„Ø¨Ù„Ø¯\n\n"
                    "Ù…Ø«Ø§Ù„:\nÙ…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ\n966512345678\nØ§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©"
                )
            return

        # Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± - ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
        await forward_user_messages(update, context)

    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {e}")
        try:
            await forward_user_messages(update, context)
        except Exception as e2:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„: {e2}")
# ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ====================
async def handle_admin_reply(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    try:
        print(f"ğŸ”” Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø© Ù„Ù„Ø±Ø¯: {update.message.text}")

        # Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø±Ø¯
        if 'replying_to' in context.user_data:
            target_user_id = context.user_data['replying_to']
            admin_message = update.message.text

            print(f"ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: {target_user_id}")

            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            app = Application.builder().token(MAIN_BOT_TOKEN).build()
            await app.bot.send_message(
                chat_id=target_user_id,
                text=f"ğŸ“¬ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:\n\n{admin_message}"
            )

            await update.message.reply_text(f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {target_user_id}")

            # Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¯
            del context.user_data['replying_to']

        else:
            print("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø±Ø¯")
            await update.message.reply_text(
                "âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø±Ø¯\n\n"
                "ğŸ“ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:\n"
                "1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©\n"
                "2. Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¯\n"
                "3. Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"
            )

    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ handle_admin_reply: {e}")
        await update.message.reply_text(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯: {e}")
async def forward_user_messages(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ØªØ­ÙˆÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù‚Ù†Ø§Ø© - Ù…Ø¹Ø¯Ù„"""
    try:
        # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø© Ù†ÙØ³Ù‡Ø§
        if update.effective_chat.id == int(ERROR_CHANNEL):
            return

        user_id = update.effective_user.id
        user_name = update.effective_user.first_name or "Ù…Ø³ØªØ®Ø¯Ù…"
        username = update.effective_user.username or "Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù"

        # ØªØ¬Ø§Ù‡Ù„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª
        if update.message.text and update.message.text.startswith('/'):
            return

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
        message_text = ""
        if update.message.text:
            message_text = update.message.text
        elif update.message.caption:
            message_text = update.message.caption
        else:
            message_text = "ğŸ“ Ø±Ø³Ø§Ù„Ø© Ù…ÙŠØ¯ÙŠØ§"

        print(f"ğŸ“© Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù…: {user_name} ({user_id}) - {message_text}")

        # Ø²Ø± Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        keyboard = [
            [InlineKeyboardButton(f"ğŸ“© Ø±Ø¯ Ø¹Ù„Ù‰ {user_name}", callback_data=f"reply_{user_id}")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        # âœ… Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ù… context.bot Ø¨Ø¯Ù„ Ø¹Ù…Ù„ Application Ø¬Ø¯ÙŠØ¯
        await context.bot.send_message(
            chat_id=ERROR_CHANNEL,
            text=f"ğŸ“¬ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©:\n\n"
                 f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user_name}\n"
                 f"ğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: @{username}\n"
                 f"ğŸ”¢ ID: {user_id}\n\n"
                 f"ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:\n{message_text}",
            reply_markup=reply_markup
        )

    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ forward_user_messages: {e}")
# ===================Ø¹Ø±Ø¶ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©  =================
async def show_messaging_system(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¹Ø±Ø¶ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©"""
    try:
        query = update.callback_query
        await query.answer()

        text = "ğŸ“© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©\n\n"
        text += "â€¢ Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªØµÙ„ Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹\n"
        text += "â€¢ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' ÙÙŠ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø©\n"
        text += "â€¢ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ ÙˆØ³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§\n\n"
        text += "ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ Ø§Ø³ØªØ®Ø¯Ø§Ù…:\n"
        text += "/broadcast Ù†Øµ_Ø§Ù„Ø±Ø³Ø§Ù„Ø© â† Ù„Ù„Ø¬Ù…ÙŠØ¹\n"
        text += "/send user_id Ø§Ù„Ø±Ø³Ø§Ù„Ø© â† Ù„Ù…Ø³ØªØ®Ø¯Ù…"

        keyboard = [
            [InlineKeyboardButton("ğŸ”„ ØªØ­Ø¯ÙŠØ«", callback_data="messaging_system")],
            [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_admin")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(text, reply_markup=reply_markup)
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ show_messaging_system: {e}")

async def admin_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¨Ø¯Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…Ø­Ø¯Ø«Ø©"""
    try:
        query = update.callback_query
        await query.answer()

        keyboard = [
            [InlineKeyboardButton("ğŸ“© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©", callback_data="messaging_system")],
            [InlineKeyboardButton("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", callback_data="admin_stats")],
            [InlineKeyboardButton("ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data="admin_users")],
            [InlineKeyboardButton("ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­", callback_data="add_profit_menu")],
            [InlineKeyboardButton("ğŸ”„ ØªØ­Ø¯ÙŠØ«", callback_data="admin_refresh")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            "ğŸ› ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†\n\nØ§Ø®ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:",
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ admin_start: {e}")
async def handle_user_messages(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ØªÙˆØ¬ÙŠÙ‡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø«"""
    try:
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø³Ø­Ø¨
        if context.user_data.get('awaiting_withdrawal_wallet'):
            await handle_withdrawal_wallet(update, context)
            return

        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        if context.user_data.get('awaiting_registration'):
            await handle_user_registration(update, context)
            return

        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø­ÙØ¸Ø© Ø¯Ø§Ø¦Ù…Ø© (Ø¥Ø°Ø§ Ù…Ø§ Ø²Ù„Øª ØªØ­ØªØ§Ø¬Ù‡Ø§)
        if context.user_data.get('awaiting_wallet'):
            await handle_wallet_address(update, context)
            return

        # Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± - ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
        await forward_user_messages(update, context)

    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {e}")
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ù„ØªÙƒ")

async def handle_admin_to_user_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ù‚Ù†Ø§Ø©"""
    try:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù‚Ù†Ø§Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
        if str(update.effective_chat.id) != ADMIN_CHAT_ID:
            return

        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªÙ‡Ø¯Ù Ù„Ù„Ø±Ø³Ø§Ù„Ø©
        if 'admin_message_target' in context.user_data:
            user_id = context.user_data['admin_message_target']
            admin_message = update.message.text

            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await context.bot.send_message(
                chat_id=user_id,
                text=f"ğŸ“© Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:\n\n{admin_message}\n\n"
                     f"Ù…Ø¹ ØªØ­ÙŠØ§Øª ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù… ğŸŒŸ"
            )

            # ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¥Ø¯Ù…Ù†
            await update.message.reply_text(
                f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}"
            )

            # Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
            del context.user_data['admin_message_target']

    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£Ø¯Ù…Ù†: {e}")
        await update.message.reply_text(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {e}")
