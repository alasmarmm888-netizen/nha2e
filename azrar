async def handle_admin_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©"""
    query = update.callback_query
    await query.answer()

    data = query.data
    user_id = int(data.split(":")[1])

    if data.startswith("confirm_transfer:"):
        # Ø²Ø± "ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„"
        await context.bot.send_message(
            chat_id=user_id,
            text="âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­!\n\n"
                 "Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ø®Ø¯Ù…Ø§ØªÙ†Ø§. ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø±ØµÙŠØ¯Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ù…Ø± /balance"
        )

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©
        await query.edit_message_text(
            text=f"âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}\n\n"
                 f"Ø¨ÙˆØ§Ø³Ø·Ø©: {query.from_user.first_name}",
            reply_markup=None
        )

    elif data.startswith("reject_transfer:"):
        # Ø²Ø± "ØªÙ… Ø§Ù„Ø±ÙØ¶"
        await context.bot.send_message(
            chat_id=user_id,
            text="âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨\n\n"
                 "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…."
        )

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©
        await query.edit_message_text(
            text=f"âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}\n\n"
                 f"Ø¨ÙˆØ§Ø³Ø·Ø©: {query.from_user.first_name}",
            reply_markup=None
        )

    elif data.startswith("message_user:"):
        # Ø²Ø± "Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©" - Ù†Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        context.user_data['awaiting_user_message'] = user_id
        await query.message.reply_text(
            f"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}:"
        )

async def handle_admin_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©"""
    query = update.callback_query
    await query.answer()

    data = query.data
    parts = data.split(":")
    action = parts[0]

    if data == "admin_refresh":
        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø© - Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ø§Ù… edit_message_text Ø¨Ø¯Ù„ send_admin_panel_to_channel
        try:
            keyboard = [
                [InlineKeyboardButton("ğŸ“© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©", callback_data="messaging_system")],
                [InlineKeyboardButton("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", callback_data="admin_stats")],
                [InlineKeyboardButton("ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data="admin_users")],
                [InlineKeyboardButton("ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­", callback_data="add_profit_menu")],
                [InlineKeyboardButton("ğŸ”„ ØªØ­Ø¯ÙŠØ«", callback_data="admin_refresh")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            await query.edit_message_text(
                "ğŸ› ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†\n\nØ§Ø®ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:",
                reply_markup=reply_markup,
                parse_mode='Markdown'
            )
            await query.answer("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø©")
        except Exception as e:
            await query.answer("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«")
        return

    if data == "add_profit_menu":
        # ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
        await query.message.reply_text(
            "ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…\n\n"
            "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ù…Ø±:\n"
            "<code>/addprofit user_id amount</code>\n\n"
            "Ù…Ø«Ø§Ù„:\n"
            "<code>/addprofit 123456789 150.75</code>",
            parse_mode='HTML'
        )
        return

    if data == "messaging_system":
        # Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©
        await query.message.reply_text(
            "ğŸ“© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©\n\n"
            "Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù…Ø³ØªØ®Ø¯Ù…:\n"
            "1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± 'Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©' ÙÙŠ Ø£ÙŠ Ø·Ù„Ø¨\n"
            "2. Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… /message user_id"
        )
        return

    if data == "admin_stats":
        # Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        try:
            conn = sqlite3.connect('trading_bot.db')
            c = conn.cursor()

            c.execute('SELECT COUNT(*) FROM users')
            total_users = c.fetchone()[0]

            c.execute('SELECT COUNT(*) FROM users WHERE date(registration_date) = date("now")')
            new_today = c.fetchone()[0]

            c.execute('SELECT SUM(balance) FROM users')
            total_balance = c.fetchone()[0] or 0

            conn.close()

            await query.message.reply_text(
                f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª:\n\n"
                f"ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {total_users}\n"
                f"ğŸ†• Ù…Ø³Ø¬Ù„ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…: {new_today}\n"
                f"ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©: {total_balance:.2f}\n"
                f"ğŸ•’ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {datetime.now().strftime('%Y-%m-%d %H:%M')}"
            )
        except Exception as e:
            await query.message.reply_text(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: {e}")
        return

    if data == "admin_users":
        # Ø¢Ø®Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        try:
            conn = sqlite3.connect('trading_bot.db')
            c = conn.cursor()
            c.execute('SELECT user_id, full_name, registration_date FROM users ORDER BY registration_date DESC LIMIT 5')
            users = c.fetchall()
            conn.close()

            users_text = "ğŸ‘¥ Ø¢Ø®Ø± 5 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:\n\n"
            for user in users:
                user_id, full_name, reg_date = user
                users_text += f"ğŸ†” {user_id}\nğŸ“› {full_name or 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\nğŸ“… {reg_date}\n\n"

            await query.message.reply_text(users_text)
        except Exception as e:
            await query.message.reply_text(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {e}")
        return

    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø­Ø¨
    if action == "confirm_withdrawal":

# ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨
        user_id = int(parts[1])
        amount = float(parts[2])
        try:
            # Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            conn = sqlite3.connect('trading_bot.db')
            c = conn.cursor()
            c.execute('UPDATE users SET balance = balance - ? WHERE user_id = ?', (amount, user_id))
            conn.commit()
            conn.close()

            await context.bot.send_message(
                chat_id=user_id,
                text=f"âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸ØªÙƒ!\n\n"
                     f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount}\n"
                     f"ğŸ”„ ØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯Ùƒ\n\n"
                     f"Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ø®Ø¯Ù…Ø§ØªÙ†Ø§. ğŸŒŸ"
            )
            await query.edit_message_text(
                text=query.message.text + f"\n\nâœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© {query.from_user.first_name}",
                reply_markup=None
            )
        except Exception as e:
            await query.message.reply_text(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯: {e}")

    elif action == "processing_withdrawal":
        # Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        user_id = int(parts[1])
        amount = float(parts[2])
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"ğŸ”„ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨...\n\n"
                     f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount}\n"
                     f"â° Ø³ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.\n\n"
                     f"Ø´ÙƒØ±Ø§Ù‹ Ù„ØµØ¨Ø±Ùƒ! ğŸ™"
            )
            await query.edit_message_text(
                text=query.message.text + f"\n\nğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙˆØ§Ø³Ø·Ø© {query.from_user.first_name}",
                reply_markup=None
            )
        except Exception as e:
            await query.message.reply_text(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯: {e}")

    elif action == "reject_withdrawal":
        # Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨
        user_id = int(parts[1])
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text="âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨\n\n"
                     "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.\n"
                     "Ø£Ùˆ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹."
            )
            await query.edit_message_text(
                text=query.message.text + f"\n\nâŒ ØªÙ… Ø§Ù„Ø±ÙØ¶ Ø¨ÙˆØ§Ø³Ø·Ø© {query.from_user.first_name}",
                reply_markup=None
            )
        except Exception as e:
            await query.message.reply_text(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ÙØ¶: {e}")

    elif action == "confirm_profit":
        # ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ø§Ù„Ø£Ø±Ø¨Ø§Ø­)
        user_id = int(parts[1])
        amount = float(parts[2])

        try:
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            conn = sqlite3.connect('trading_bot.db')
            c = conn.cursor()
            c.execute(
                'UPDATE users SET balance = balance + ? WHERE user_id = ?',
                (amount, user_id)
            )
            conn.commit()

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            c.execute('SELECT balance FROM users WHERE user_id = ?', (user_id,))
            new_balance = c.fetchone()[0]
            conn.close()

            # Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await context.bot.send_message(
                chat_id=user_id,
                text=f"ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­ Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ!\n\n"
                     f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount}\n"
                     f"ğŸ’³ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: {new_balance}\n\n"
                     f"Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§! ğŸŒŸ"
            )

            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©
            await query.edit_message_text(
                text=query.message.text + f"\n\nâœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ§Ø³Ø·Ø© {query.from_user.first_name}",
                reply_markup=None
            )

        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: {e}")
            await query.message.reply_text(f"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: {e}")

    elif action == "message_user":
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        user_id = int(parts[1])
        context.user_data['admin_message_target'] = user_id
        await query.message.reply_text(
            f"ğŸ’¬ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}:"
        )
# ==================== Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ====================
if __name__ == "__main__":
    # ØªÙ‡ÙŠØ¦Ø© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¨ÙˆØª
    init_referral_system()
    print("âœ… Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¨ÙˆØª Ù…Ù‡ÙŠØ£Ø©")

    app = Application.builder().token(MAIN_BOT_TOKEN).build()

    # Ø¥Ø¶Ø§ÙØ© handlers Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("test", test_command))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("stats", admin_stats_command))
    app.add_handler(CommandHandler("users", admin_users_command))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_user_registration))
    app.add_handler(MessageHandler(filters.PHOTO, handle_payment_proof))
    app.add_handler(CallbackQueryHandler(handle_buttons))
    app.add_handler(MessageHandler(filters.TEXT & filters.Chat(chat_id=int(ERROR_CHANNEL)), handle_admin_reply))
    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, forward_user_messages))
    app.add_error_handler(error_handler)
    app.add_handler(CallbackQueryHandler(handle_admin_buttons))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_admin_to_user_message))
    app.add_handler(CallbackQueryHandler(handle_admin_callback))
    app.add_handler(CommandHandler("addprofit", handle_add_profit))
    app.add_handler(MessageHandler(filters.TEXT & filters.Chat(chat_id=ADMIN_CHAT_ID) & ~filters.COMMAND, handle_admin_to_user_message))
    app.add_handler(MessageHandler(filters.TEXT & filters.Chat(chat_id=ADMIN_CHAT_ID), handle_channel_commands))

    print("ğŸ‰ Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„ Ø§Ù„Ø¢Ù†!")
    app.run_polling(
        drop_pending_updates=True,
        close_loop=False
    )
