import os
import asyncio
import logging
import sqlite3
import time
from datetime import datetime, date
from threading import Thread
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, ContextTypes, filters
from telegram.error import TelegramError

# ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ğŸ” Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©
MAIN_BOT_TOKEN = "7566859808:AAFHlYo7nVIGDe6jnYIiI1EfsU-HeCntH5E"
ARCHIVE_CHANNEL = "-1003178411340"
ERROR_CHANNEL = "-1003091305351"
WALLET_ADDRESS = "TYy5CnBE3k..."
ADMIN_CHAT_ID = "-1003178411340"

# ğŸ“Š Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
SUBSCRIPTION_PLANS = {
    "basic": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©",
        "price": 25,
        "days": 30,
        "profits": "5-10% ÙŠÙˆÙ…ÙŠØ§Ù‹"
    },
    "pro": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©",
        "price": 50,
        "days": 30,
        "profits": "10-15% ÙŠÙˆÙ…ÙŠØ§Ù‹"
    },
    "vip": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø©",
        "price": 100,
        "days": 30,
        "profits": "15-20% ÙŠÙˆÙ…ÙŠØ§Ù‹"
    }
}

# ==================== Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
def init_database():
    """ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„"""
    try:
        conn = sqlite3.connect('trading_bot.db', check_same_thread=False)
        c = conn.cursor()

        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        c.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                full_name TEXT,
                phone TEXT,
                country TEXT,
                balance REAL DEFAULT 0.0,
                wallet_address TEXT,
                referral_code TEXT UNIQUE,
                referred_by INTEGER,
                subscription_level TEXT DEFAULT 'basic',
                registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                is_active INTEGER DEFAULT 1
            )
        ''')

        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
        c.execute('''
            CREATE TABLE IF NOT EXISTS transactions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                type TEXT,
                amount REAL,
                status TEXT,
                description TEXT,
                transaction_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (user_id)
            )
        ''')

        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
        c.execute('''
            CREATE TABLE IF NOT EXISTS referrals (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                referrer_id INTEGER,
                referred_id INTEGER,
                commission_earned REAL DEFAULT 0,
                referral_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (referrer_id) REFERENCES users (user_id),
                FOREIGN KEY (referred_id) REFERENCES users (user_id)
            )
        ''')

        conn.commit()
        conn.close()
        logger.info("âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù‡ÙŠØ£Ø© Ø¨Ù†Ø¬Ø§Ø­")
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")

init_database()

# ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ====================
def get_user_data(user_id):
    """Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    try:
        conn = sqlite3.connect('trading_bot.db', check_same_thread=False)
        c = conn.cursor()
        c.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
        user = c.fetchone()
        conn.close()
        return user
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
        return None

def update_user_balance(user_id, amount):
    """ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    try:
        conn = sqlite3.connect('trading_bot.db', check_same_thread=False)
        c = conn.cursor()
        c.execute("UPDATE users SET balance = balance + ? WHERE user_id = ?", (amount, user_id))
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯: {e}")
        return False

# ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ====================
async def send_admin_notification(message):
    """Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ø¯Ù…Ù†"""
    try:
        app = Application.builder().token(MAIN_BOT_TOKEN).build()
        await app.bot.send_message(
            chat_id=ADMIN_CHAT_ID,
            text=f"ğŸ‘¨â€ğŸ’¼ {message}\nâ° {datetime.now().strftime('%Y-%m-%d %H:%M')}"
        )
    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: {e}")

# ==================== Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ====================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"""
    try:
        user_id = update.effective_user.id
        user_name = update.effective_user.first_name

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        referral_code = None
        if context.args and context.args[0].startswith('REF'):
            referral_code = context.args[0]

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
        user_data = get_user_data(user_id)

        if not user_data:
            # Ø·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            context.user_data['awaiting_registration'] = True
            if referral_code:
                context.user_data['referral_code'] = referral_code

            await update.message.reply_text(
                f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user_name}! ğŸ‘‹\n\n"
                "ğŸš€ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„:\n"
                "1. Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ\n"
                "2. Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨\n"
                "3. Ø§Ù„Ø¨Ù„Ø¯\n\n"
                "Ù…Ø«Ø§Ù„:\n"
                "Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ\n"
                "966512345678\n"
                "Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©"
            )

            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
            await send_admin_notification(f"ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙˆØª: {user_name} (ID: {user_id})")
        else:
            # Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            await show_main_menu(update, context)
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø£Ù…Ø± start: {e}")

async def show_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    try:
        user_id = update.effective_user.id
        user_data = get_user_data(user_id)
        balance = user_data[5] if user_data else 0

        keyboard = [
            [InlineKeyboardButton("ğŸ’¼ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data="subscription_plans")],
            [InlineKeyboardButton("ğŸ’° Ø±ØµÙŠØ¯ÙŠ", callback_data="check_balance")],
            [InlineKeyboardButton("ğŸ Ø§Ø¯Ø¹Ùˆ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ", callback_data="referral_system")],
            [InlineKeyboardButton("ğŸ’³ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­", callback_data="withdraw_menu")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        if update.callback_query:
            await update.callback_query.edit_message_text(
                f"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ! ğŸ‘‹\n"
                f"ğŸ’¼ Ù…Ø­ÙØ¸ØªÙƒ: {balance:.2f} USDT\n\n"
                "Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:",
                reply_markup=reply_markup
            )
        else:
            await update.message.reply_text(
                f"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ! ğŸ‘‹\n"
                f"ğŸ’¼ Ù…Ø­ÙØ¸ØªÙƒ: {balance:.2f} USDT\n\n"
                "Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:",
                reply_markup=reply_markup
            )
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: {e}")

# ==================== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ====================
async def handle_user_registration(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    try:
        user_id = update.effective_user.id
        message_text = update.message.text

        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        if context.user_data.get('awaiting_registration'):
            lines = message_text.strip().split('\n')
            if len(lines) >= 3:
                name = lines[0].strip()
                phone = lines[1].strip()
                country = lines[2].strip()

                # Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                conn = sqlite3.connect('trading_bot.db')
                c = conn.cursor()
                c.execute('''
                    INSERT OR REPLACE INTO users
                    (user_id, username, full_name, phone, country, balance, registration_date)
                    VALUES (?, ?, ?, ?, ?, 0, datetime('now'))
                ''', (user_id, update.effective_user.username, name, phone, country))
                conn.commit()
                conn.close()

                # Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                del context.user_data['awaiting_registration']

                await update.message.reply_text(
                    f"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ Ø¨Ù†Ø¬Ø§Ø­!\n\n"
                    f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {name}\n"
                    f"ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: {phone}\n"
                    f"ğŸŒ Ø§Ù„Ø¨Ù„Ø¯: {country}\n\n"
                    f"ğŸš€ Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„!"
                )

                # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†
                await send_admin_notification(
                    f"ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:\n"
                    f"Ø§Ù„Ø§Ø³Ù…: {name}\n"
                    f"Ø§Ù„Ù‡Ø§ØªÙ: {phone}\n"
                    f"Ø§Ù„Ø¨Ù„Ø¯: {country}\n"
                    f"ID: {user_id}\n"
                    f"@{update.effective_user.username or 'Ø¨Ø¯ÙˆÙ†'}"
                )

                # Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                await show_main_menu(update, context)
            else:
                await update.message.reply_text(
                    "âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©:\n\n"
                    "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ\nØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\nØ§Ù„Ø¨Ù„Ø¯\n\n"
                    "Ù…Ø«Ø§Ù„:\nÙ…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ\n966512345678\nØ§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©"
                )
            return

    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {e}")
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„")

# ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ====================
async def show_withdraw_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø­Ø¨"""
    try:
        query = update.callback_query
        await query.answer()

        user_id = query.from_user.id
        user_data = get_user_data(user_id)
        balance = user_data[5] if user_data else 0

        keyboard = [
            [InlineKeyboardButton("ğŸ’³ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­", callback_data="withdraw_profits")],
            [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            f"ğŸ’³ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨\n\n"
            f"ğŸ’° Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: {balance:.2f} USDT\n\n"
            f"Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³Ø­Ø¨:",
            reply_markup=reply_markup
        )
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø­Ø¨: {e}")

async def handle_withdraw_profits(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­"""
    try:
        query = update.callback_query
        await query.answer()

        user_id = query.from_user.id
        user_data = get_user_data(user_id)
        balance = user_data[5] if user_data else 0

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
        if balance < 25:
            await query.edit_message_text(
                f"âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø³Ø­Ø¨\n\n"
                f"ğŸ’° Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: {balance:.2f} USDT\n"
                f"ğŸ“Š Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨: 25 USDT\n\n"
                f"ğŸ’¡ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­!",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="withdraw_menu")]
                ])
            )
            return

        # Ø·Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©
        context.user_data['awaiting_withdrawal'] = True
        context.user_data['withdrawal_user_id'] = user_id
        context.user_data['withdrawal_amount'] = balance

        await query.edit_message_text(
            f"ğŸ’³ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­\n\n"
            f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {balance:.2f} USDT\n"
            f"â° Ù…Ø¯Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: 24 Ø³Ø§Ø¹Ø©\n\n"
            f"ğŸ”— ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙƒ:"
        )

    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: {e}")

async def handle_withdrawal_wallet(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ù„Ø³Ø­Ø¨"""
    try:
        user_id = context.user_data.get('withdrawal_user_id')
        wallet_address = update.message.text.strip()
        amount = context.user_data.get('withdrawal_amount')

        if not user_id:
            await update.message.reply_text("âŒ Ø¬Ù„Ø³Ø© Ù…Ù†ØªÙ‡ÙŠØ©ØŒ Ø§Ø¨Ø¯Ø£ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯")
            return

        # ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        if len(wallet_address) < 10:
            await update.message.reply_text("âŒ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹")
            return

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        user_data = get_user_data(user_id)
        if not user_data:
            await update.message.reply_text("âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
            return

        balance, full_name, username = user_data[5], user_data[2], user_data[1]

        # Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ù‚Ù†Ø§Ø© Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        keyboard = [
            [
                InlineKeyboardButton("âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„", callback_data=f"confirm_withdrawal:{user_id}:{amount}"),
                InlineKeyboardButton("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©", callback_data=f"processing_withdrawal:{user_id}:{amount}")
            ],
            [
                InlineKeyboardButton("âŒ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨", callback_data=f"reject_withdrawal:{user_id}"),
                InlineKeyboardButton("ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©", callback_data=f"message_user:{user_id}")
            ]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await context.bot.send_message(
            chat_id=ADMIN_CHAT_ID,
            text=f"ğŸ”„ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯:\n\n"
                 f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {full_name or 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\n"
                 f"ğŸ”— @{username or 'Ø¨Ø¯ÙˆÙ†'}\n"
                 f"ğŸ†” ID: {user_id}\n"
                 f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} USDT\n"
                 f"ğŸ’³ Ø§Ù„Ø±ØµÙŠØ¯: {balance} USDT\n"
                 f"ğŸ”— Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_address}\n\n"
                 f"â° {datetime.now().strftime('%Y-%m-%d %H:%M')}",
            reply_markup=reply_markup
        )

        # ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await update.message.reply_text(
            f"âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨!\n\n"
            f"ğŸ’³ Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_address}\n"
            f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} USDT\n\n"
            f"ğŸ”„ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©..."
        )

        # Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        context.user_data.pop('awaiting_withdrawal', None)
        context.user_data.pop('withdrawal_user_id', None)
        context.user_data.pop('withdrawal_amount', None)

    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø³Ø­Ø¨: {e}")
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨")

# ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ====================
async def send_admin_panel(context: ContextTypes.DEFAULT_TYPE):
    """Ø¥Ø±Ø³Ø§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©"""
    try:
        keyboard = [
            [InlineKeyboardButton("ğŸ“© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©", callback_data="messaging_system")],
            [InlineKeyboardButton("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", callback_data="admin_stats")],
            [InlineKeyboardButton("ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data="admin_users")],
            [InlineKeyboardButton("ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­", callback_data="add_profit_menu")],
            [InlineKeyboardButton("ğŸ”„ ØªØ­Ø¯ÙŠØ«", callback_data="admin_refresh")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await context.bot.send_message(
            chat_id=ADMIN_CHAT_ID,
            text="ğŸ› ï¸ **Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†**\n\nØ§Ø®ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:",
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
        logger.info("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù†Ø§Ø©")
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: {e}")

async def admin_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¨Ø¯Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†"""
    try:
        query = update.callback_query
        await query.answer()

        keyboard = [
            [InlineKeyboardButton("ğŸ“© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©", callback_data="messaging_system")],
            [InlineKeyboardButton("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", callback_data="admin_stats")],
            [InlineKeyboardButton("ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data="admin_users")],
            [InlineKeyboardButton("ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­", callback_data="add_profit_menu")],
            [InlineKeyboardButton("ğŸ”„ ØªØ­Ø¯ÙŠØ«", callback_data="admin_refresh")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            "ğŸ› ï¸ **Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†**\n\nØ§Ø®ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:",
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ admin_start: {e}")

async def show_admin_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†"""
    query = update.callback_query
    await query.answer()
    
    try:
        conn = sqlite3.connect('trading_bot.db')
        c = conn.cursor()
        
        c.execute("SELECT COUNT(*) FROM users")
        total_users = c.fetchone()[0]
        
        c.execute("SELECT SUM(balance) FROM users")
        total_balance = c.fetchone()[0] or 0
        
        conn.close()
        
        stats_text = (
            f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª\n\n"
            f"ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {total_users}\n"
            f"ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©: {total_balance:.2f} USDT\n"
            f"ğŸ•’ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {datetime.now().strftime('%Y-%m-%d %H:%M')}"
        )
        
        keyboard = [[InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin_refresh")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(stats_text, reply_markup=reply_markup)
        
    except Exception as e:
        await query.message.reply_text(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: {e}")

# ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ====================
async def handle_callback_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    
    try:
        logger.info(f"ğŸ”˜ Ø²Ø± Ù…Ø¶ØºÙˆØ·: {data}")
        
        if data == "back_to_main":
            await show_main_menu(update, context)
            
        elif data == "withdraw_menu":
            await show_withdraw_menu(update, context)
            
        elif data == "withdraw_profits":
            await handle_withdraw_profits(update, context)
            
        elif data.startswith("confirm_withdrawal:"):
            parts = data.split(":")
            user_id = int(parts[1])
            amount = float(parts[2])
            await confirm_withdrawal(update, context, user_id, amount)
            
        elif data.startswith("reject_withdrawal:"):
            user_id = int(data.split(":")[1])
            await reject_withdrawal(update, context, user_id)
            
        elif data == "admin_stats":
            await show_admin_stats(update, context)
            
        elif data == "admin_users":
            await show_admin_users(update, context)
            
        elif data == "add_profit_menu":
            await query.message.reply_text(
                "ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…\n\n"
                "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ù…Ø±:\n"
                "/addprofit <user_id> <amount>\n\n"
                "Ù…Ø«Ø§Ù„:\n"
                "/addprofit 123456789 150.75"
            )
            
        elif data == "admin_refresh":
            await send_admin_panel(context)
            await query.answer("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø©")
            
        elif data == "subscription_plans":
            await show_subscription_plans(update, context)
            
        elif data == "check_balance":
            user_id = query.from_user.id
            user_data = get_user_data(user_id)
            balance = user_data[5] if user_data else 0
            await query.edit_message_text(f"ğŸ’¼ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: {balance:.2f} USDT")
            
        elif data == "referral_system":
            await show_referral_system(update, context)
            
        else:
            await query.answer("âš™ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§ØµÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±")
            
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø²Ø± {data}: {e}")
        await query.answer("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")

async def confirm_withdrawal(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: int, amount: float):
    """ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨"""
    query = update.callback_query
    
    try:
        # Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        conn = sqlite3.connect('trading_bot.db')
        c = conn.cursor()
        c.execute('UPDATE users SET balance = balance - ? WHERE user_id = ?', (amount, user_id))
        conn.commit()
        conn.close()
        
        # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await context.bot.send_message(
            chat_id=user_id,
            text=f"âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸ØªÙƒ!\n\n"
                 f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} USDT\n"
                 f"ğŸ”„ ØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯Ùƒ\n\n"
                 f"Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ø®Ø¯Ù…Ø§ØªÙ†Ø§. ğŸŒŸ"
        )
        
        await query.edit_message_text(
            text=query.message.text + f"\n\nâœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© {query.from_user.first_name}",
            reply_markup=None
        )
        
    except Exception as e:
        await query.message.reply_text(f"âŒ ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨: {e}")

async def reject_withdrawal(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: int):
    """Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨"""
    query = update.callback_query
    
    try:
        await context.bot.send_message(
            chat_id=user_id,
            text="âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨\n\n"
                 "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª."
        )
        
        await query.edit_message_text(
            text=query.message.text + f"\n\nâŒ ØªÙ… Ø§Ù„Ø±ÙØ¶ Ø¨ÙˆØ§Ø³Ø·Ø© {query.from_user.first_name}",
            reply_markup=None
        )
        
    except Exception as e:
        await query.message.reply_text(f"âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨: {e}")

# ==================== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© ====================
async def show_subscription_plans(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ø¹Ø±Ø¶ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"""
    try:
        query = update.callback_query
        await query.answer()

        keyboard = []
        for plan_id, plan in SUBSCRIPTION_PLANS.items():
            keyboard.append([
                InlineKeyboardButton(
                    f"{plan['name']} - {plan['price']} USDT",
                    callback_data=f"subscribe_{plan_id}"
                )
            ])

        keyboard.append([InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")])
        reply_markup = InlineKeyboardMarkup(keyboard)

        plans_text = "ğŸ’¼ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…ØªØ§Ø­Ø©:\n\n"
        for plan_id, plan in SUBSCRIPTION_PLANS.items():
            plans_text += f"{plan['name']}\n"
            plans_text += f"ğŸ’° Ø§Ù„Ø³Ø¹Ø±: {plan['price']} USDT\n"
            plans_text += f"â³ Ø§Ù„Ù…Ø¯Ø©: {plan['days']} ÙŠÙˆÙ…\n"
            plans_text += f"ğŸ“ˆ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: {plan['profits']}\n\n"

        await query.edit_message_text(plans_text, reply_markup=reply_markup)
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: {e}")

async def show_admin_users(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ø£Ø¯Ù…Ù†"""
    query = update.callback_query
    
    try:
        conn = sqlite3.connect('trading_bot.db')
        c = conn.cursor()
        c.execute("SELECT user_id, full_name, balance FROM users ORDER BY registration_date DESC LIMIT 10")
        users = c.fetchall()
        conn.close()
        
        users_text = "ğŸ‘¥ Ø¢Ø®Ø± 10 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:\n\n"
        for user in users:
            user_id, full_name, balance = user
            users_text += f"ğŸ†” {user_id} | ğŸ“› {full_name or 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} | ğŸ’° {balance}\n"
        
        keyboard = [[InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin_refresh")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(users_text, reply_markup=reply_markup)
        
    except Exception as e:
        await query.message.reply_text(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {e}")

async def show_referral_system(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ø¹Ø±Ø¶ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©"""
    try:
        query = update.callback_query
        await query.answer()

        user_id = query.from_user.id
        referral_code = f"REF{user_id}"
        referral_link = f"https://t.me/Arba7Saudi_bot?start={referral_code}"

        referral_text = f"""ğŸ **Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹ÙˆØ© ÙˆØ§Ù„ØªÙˆØµÙŠØ©**

ğŸ’¼ **ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØªÙƒ:** `{referral_code}`

ğŸ”— **Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©:**
`{referral_link}`

ğŸ“£ **ÙƒÙŠÙ ØªØ³ØªØ®Ø¯Ù…:**
1. Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¹Ù„Ø§Ù‡ ğŸ“‹
2. Ø£Ø±Ø³Ù„Ù‡ Ù„Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ğŸ“¤
3. Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ†Ø¶Ù… ØµØ¯ÙŠÙ‚ØŒ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆÙ„Ø© 10% Ù…Ù† Ø§ÙŠØ¯Ø§Ø¹Ù‡ ğŸ’°"""

        keyboard = [
            [InlineKeyboardButton("ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·", callback_data="copy_referral_link")],
            [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            referral_text,
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )

    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: {e}")

# ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ====================
async def handle_all_messages(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    try:
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø­Ø¨
        if context.user_data.get('awaiting_withdrawal'):
            await handle_withdrawal_wallet(update, context)
            return
            
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        if context.user_data.get('awaiting_registration'):
            await handle_user_registration(update, context)
            return
            
        # Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± - ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        await update.message.reply_text("âŒ Ù„Ù… Ø£ÙÙ‡Ù… Ø±Ø³Ø§Ù„ØªÙƒ. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.")
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {e}")
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ù„ØªÙƒ")

# ==================== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù† ====================
async def handle_add_profit(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­ Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    try:
        # Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø¥Ø¯Ù…Ù† ÙÙ‚Ø·
        if str(update.effective_user.id) not in [ADMIN_CHAT_ID]:
            return

        if len(context.args) != 2:
            await update.message.reply_text(
                "ğŸ“Š Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:\n\n"
                "Ø§Ø³ØªØ®Ø¯Ø§Ù…: /addprofit <user_id> <amount>\n\n"
                "Ù…Ø«Ø§Ù„: /addprofit 123456789 100.5"
            )
            return

        target_user_id = int(context.args[0])
        amount = float(context.args[1])

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
        if update_user_balance(target_user_id, amount):
            await update.message.reply_text(
                f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {amount} Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {target_user_id}"
            )
            
            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            try:
                await context.bot.send_message(
                    chat_id=target_user_id,
                    text=f"ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­ Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ!\n\n"
                         f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount}\n\n"
                         f"Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§! ğŸŒŸ"
                )
            except:
                pass
        else:
            await update.message.reply_text("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­")
            
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: {e}")
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨")

# ==================== Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ====================
def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    app = Application.builder().token(MAIN_BOT_TOKEN).build()

    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("addprofit", handle_add_profit))
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_all_messages))
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    app.add_handler(CallbackQueryHandler(handle_callback_buttons))

    # Ø¥Ø±Ø³Ø§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    async def send_initial_panel(application: Application):
        await send_admin_panel(application)
    
    app.post_init = send_initial_panel

    print("ğŸ‰ Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„ Ø§Ù„Ø¢Ù†!")
    app.run_polling(drop_pending_updates=True)

if __name__ == "__main__":
    main()
