import os
import asyncio
import logging
import sqlite3
import time
from datetime import datetime, date
from threading import Thread
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, ContextTypes, filters
from telegram.error import TelegramError

# ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
# Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± â¬‡ï¸
logger = logging.getLogger(__name__)

# ğŸ” Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù…Ø¨Ø§Ø´Ø±Ø©
MAIN_BOT_TOKEN = "7566859808:AAFHlYo7nVIGDe6jnYIiI1EfsU-HeCntH5E"
ARCHIVE_CHANNEL = "-1003178411340"
ERROR_CHANNEL = "-1003091305351"
WALLET_ADDRESS = "TYy5CnBE3k..."
ADMIN_CHAT_ID = "-1003178411340"
CHANNEL_USERNAME = "@hotpum"
# ğŸ“Š Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ù‚ÙŠ
SUBSCRIPTION_PLANS = {
    "bronze": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¨Ø±ÙˆÙ†Ø²ÙŠØ©",
        "price": 100,
        "days": 3,
        "profits": "10% â€“ 20%",
        "level": 1
    },
    "silver": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙØ¶ÙŠØ©",
        "price": 500,
        "days": 3,
        "profits": "15% â€“ 25%",
        "level": 2
    },
    "gold": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©",
        "price": 1000,
        "days": 7,
        "profits": "20% â€“ 35%",
        "level": 3
    },
    "platinum": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¨Ù„Ø§ØªÙŠÙ†ÙŠØ©",
        "price": 5000,
        "days": 15,
        "profits": "35% â€“ 50%",
        "level": 4
    },
    "diamond": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø§Ø³ÙŠØ©",
        "price": 10000,
        "days": 30,
        "profits": "50% â€“ 80%",
        "level": 5
    },
    "royal": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ© ğŸ‘‘",
        "price": 20000,
        "days": 30,
        "profits": "Ø­ØªÙ‰ 100%",
        "features": "Ù…ØªØ§Ø¨Ø¹Ø© Ø®Ø§ØµØ© Ù…Ù† ÙƒØ¨Ø§Ø± Ø§Ù„Ø®Ø¨Ø±Ø§Ø¡ + ØªÙ‚Ø§Ø±ÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø©",
        "level": 6
    },
    "legendary": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ© ğŸ†",
        "price": 50000,
        "days": 30,
        "profits": "120% â€“ 150%",
        "level": 7
    }
}
# ==================== ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
def init_database():
    """ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„"""
    try:
        conn = sqlite3.connect('trading_bot.db', check_same_thread=False)
        c = conn.cursor()

        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù…Ø­Ø¯Ø«)
        c.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                full_name TEXT,
                phone TEXT,
                country TEXT,
                balance REAL DEFAULT 0.0,
                wallet_address TEXT,
                referral_code TEXT UNIQUE,
                referred_by INTEGER,
                subscription_level TEXT DEFAULT 'basic',
                registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                is_active INTEGER DEFAULT 1
            )
        ''')

        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
        c.execute('''
            CREATE TABLE IF NOT EXISTS transactions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                type TEXT,
                amount REAL,
                status TEXT,
                description TEXT,
                transaction_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (user_id)
            )
        ''')

        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
        c.execute('''
            CREATE TABLE IF NOT EXISTS referrals (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                referrer_id INTEGER,
                referred_id INTEGER,
                commission_earned REAL DEFAULT 0,
                referral_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (referrer_id) REFERENCES users (user_id),
                FOREIGN KEY (referred_id) REFERENCES users (user_id)
            )
        ''')
        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        c.execute('''
            CREATE TABLE IF NOT EXISTS admin_messages (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                chat_id TEXT,
                target_user_id INTEGER,
                message_type TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        conn.commit()
        conn.close()
        logger.info("âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù‡ÙŠØ£Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©")
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")

# ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ init_database Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
init_database()
# ==================== Ø¯ÙˆØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
def get_user_data(user_id):
    """Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ùƒ dictionary"""
    try:
        conn = sqlite3.connect('trading_bot.db', check_same_thread=False)
        c = conn.cursor()
        c.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
        user = c.fetchone()
        conn.close()

        if user:
            # ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ dictionary
            columns = ['user_id', 'username', 'full_name', 'phone', 'country',
                      'balance', 'wallet_address', 'referral_code', 'referred_by',
                      'subscription_level', 'registration_date', 'last_activity', 'is_active']
            return dict(zip(columns, user))
        return None
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
        return None

def register_user(user_id, full_name, phone, country, referral_code=None):
    """ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯"""
    try:
        conn = sqlite3.connect('trading_bot.db', check_same_thread=False)
        c = conn.cursor()

        # Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø© ÙØ±ÙŠØ¯
        user_referral_code = f"REF{user_id}{datetime.now().strftime('%H%M')}"

        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø­ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø©
        referred_by = None
        if referral_code:
            c.execute("SELECT user_id FROM users WHERE referral_code = ?", (referral_code,))
            referrer = c.fetchone()
            if referrer:
                referred_by = referrer[0]

        c.execute('''INSERT OR REPLACE INTO users
                     (user_id, full_name, phone, country, referral_code, referred_by, registration_date)
                     VALUES (?, ?, ?, ?, ?, ?, ?)''',
                  (user_id, full_name, phone, country, user_referral_code, referred_by, date.today()))

        conn.commit()
        conn.close()

        # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø­ÙŠÙ„ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        if referred_by:
            asyncio.create_task(notify_referral_signup(referred_by, user_id, full_name))

        return user_referral_code
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
        return None

def update_user_balance(user_id, amount):
    """ØªØ­Ø¯ÙŠØ¯ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    try:
        conn = sqlite3.connect('trading_bot.db', check_same_thread=False)
        c = conn.cursor()
        c.execute("UPDATE users SET balance = balance + ? WHERE user_id = ?", (amount, user_id))
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯: {e}")
        return False

def add_transaction(user_id, transaction_type, amount, status="pending"):
    """Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©"""
    try:
        conn = sqlite3.connect('trading_bot.db', check_same_thread=False)
        c = conn.cursor()
        c.execute('''INSERT INTO transactions
                     (user_id, type, amount, status, transaction_date)
                     VALUES (?, ?, ?, ?, ?)''',
                  (user_id, transaction_type, amount, status, datetime.now()))
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {e}")
        return False
# ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ====================
async def send_admin_notification(message):
    """Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø¯Ø§Ø±ÙŠ Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (Ø§Ù„ØªÙŠ Ø£ØµØ¨Ø­Øª Ù‚Ù†Ø§Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø£ÙŠØ¶Ø§Ù‹)"""
    try:
        await asyncio.sleep(1)

        app = Application.builder().token(MAIN_BOT_TOKEN).build()
        admin_text = f"ğŸ‘¨â€ğŸ’¼ **Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø¯Ø§Ø±ÙŠ**\n\n{message}\n\nâ° Ø§Ù„ÙˆÙ‚Øª: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        await app.bot.send_message(
            chat_id=ADMIN_CHAT_ID,
            text=admin_text
        )
    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ: {e}")

async def send_error_notification(error_message):
    """Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø®Ø·Ø£ Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"""
    try:

        await asyncio.sleep(1)

        app = Application.builder().token(MAIN_BOT_TOKEN).build()
        error_text = f"ğŸš¨ **ØªÙ‚Ø±ÙŠØ± Ø®Ø·Ø£**\n\n{error_message}\n\nâ° Ø§Ù„ÙˆÙ‚Øª: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        await app.bot.send_message(
            chat_id=ERROR_CHANNEL,
            text=error_text
        )
    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø£: {e}")

async def send_to_archive(message):
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ"""
    try:
        app = Application.builder().token(MAIN_BOT_TOKEN).build()
        await app.bot.send_message(
            chat_id=ARCHIVE_CHANNEL,
            text=message
        )
    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ: {e}")

async def notify_referral_signup(referrer_id, referred_id, referred_name):
    """Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø­ÙŠÙ„ Ø¨ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§Ù„ Ø¬Ø¯ÙŠØ¯"""
    try:
        message = f"ğŸ‰ Ù„Ø¯ÙŠÙƒ Ù…Ø­Ø§Ù„ Ø¬Ø¯ÙŠØ¯!\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {referred_name}\nğŸ†” Ø§Ù„Ø£ÙŠØ¯ÙŠ: {referred_id}"
        await send_admin_notification(message)
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: {e}")

# ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ====================
def add_referral_commission(referrer_id, referred_id, amount):
    """Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©"""
    try:
        commission = amount * 0.10  # 10% Ø¹Ù…ÙˆÙ„Ø©
        conn = sqlite3.connect('trading_bot.db', check_same_thread=False)
        c = conn.cursor()

        # ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙŠÙ„
        c.execute("UPDATE users SET balance = balance + ? WHERE user_id = ?", (commission, referrer_id))

        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        c.execute('''INSERT INTO referrals
                     (referrer_id, referred_id, commission_earned, referral_date)
                     VALUES (?, ?, ?, ?)''',
                  (referrer_id, referred_id, commission, date.today()))

        conn.commit()
        conn.close()

        return commission
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: {e}")
        return 0
async def handle_withdraw_bonus(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø­Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯"""
    try:
        query = update.callback_query
        await query.answer()

        user_id = query.from_user.id
        user_data = get_user_data(user_id)

        # ØªØ­Ù‚Ù‚ Ø¢Ù…Ù† Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
        try:
            balance = float(user_data['balance']) if user_data and user_data['balance'] is not None else 0.0
        except (ValueError, TypeError):
            balance = 0.0

        # Ø·Ù„Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¯ÙˆÙŠØ§Ù‹
        context.user_data['awaiting_amount'] = True
        context.user_data['withdraw_type'] = 'bonus'

        await query.edit_message_text(
            f"ğŸ Ø³Ø­Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª\n\n"
            f"ğŸ’° Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: {balance:.2f} USDT\n"
            f"â° Ù…Ø¯Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: 48 Ø³Ø§Ø¹Ø©\n\n"
            f"ğŸ“Š Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡:\n"
            f"(Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: {balance:.2f} USDT)",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="withdraw_menu")]
            ])
        )

    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø³Ø­Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª: {e}")
        await send_error_notification(f"Ø®Ø·Ø£ ÙÙŠ Ø³Ø­Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª: {e}")
def init_referral_system():
    """ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©"""
    conn = sqlite3.connect('trading_bot.db')
    c = conn.cursor()

    # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ referrals Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
    c.execute('''
        CREATE TABLE IF NOT EXISTS referrals (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            referrer_id INTEGER,
            referred_id INTEGER,
            commission_earned DECIMAL(10,2) DEFAULT 0,
            referral_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ referral_code Ù„Ø¬Ø¯ÙˆÙ„ users Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
    try:
        c.execute("ALTER TABLE users ADD COLUMN referral_code TEXT")
        print("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ referral_code")
    except sqlite3.OperationalError:
        pass  # Ø§Ù„Ø­Ù‚Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹

    conn.commit()
    conn.close()
    print("âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù…Ù‡ÙŠØ£")

def get_referral_stats(user_id):
    """Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø©"""
    try:
        conn = sqlite3.connect('trading_bot.db')
        c = conn.cursor()

        c.execute("SELECT COUNT(*) FROM referrals WHERE referrer_id = ?", (user_id,))
        referral_count = c.fetchone()[0]

        c.execute("SELECT SUM(commission_earned) FROM referrals WHERE referrer_id = ?", (user_id,))
        result = c.fetchone()[0]
        total_commissions = result if result is not None else 0

        conn.close()
        return referral_count, total_commissions

    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: {e}")
        return 0, 0

async def show_referral_system(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ø¹Ø±Ø¶ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©"""
    try:
        query = update.callback_query
        await query.answer()

        user_id = query.from_user.id
        referral_code = f"REF{user_id}"

        # â¬‡ï¸ Ø£ÙˆÙ„Ø§Ù‹ Ø¬Ø±Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø³ÙŠØ·
        bot_username = "Arba7Saudi_bot"  # ØºÙŠØ± Ù‡Ø°Ø§ Ù„Ø§Ø³Ù… Ø¨ÙˆØªÙƒ Ø§Ù„ØµØ­ÙŠØ­
        referral_link = f"https://t.me/{bot_username}?start={referral_code}"

        # Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ£ÙƒØ¯
        referral_text = f"""ğŸ <b>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹ÙˆØ© ÙˆØ§Ù„ØªÙˆØµÙŠØ©</b>

ğŸ’¼ <b>ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØªÙƒ:</b> <code>{referral_code}</code>

ğŸ”— <b>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©:</b>
<code>{referral_link}</code>

ğŸ“£ <b>ÙƒÙŠÙ ØªØ³ØªØ®Ø¯Ù…:</b>
1. Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¹Ù„Ø§Ù‡ ğŸ“‹
2. Ø£Ø±Ø³Ù„Ù‡ Ù„Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ğŸ“¤
3.Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ†Ø¶Ù… ØµØ¯ÙŠÙ‚ØŒ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆÙ„Ø© 10% Ù…Ù† Ø§ÙŠØ¯Ø§Ø¹Ù‡ ğŸ’°"""
        keyboard = [
            [InlineKeyboardButton("ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·", callback_data="copy_referral_link")],
            [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            referral_text,
            reply_markup=reply_markup,
            parse_mode='HTML'
        )

    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: {e}")
