# ğŸ“Š Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
SUBSCRIPTION_PLANS = {
    "basic": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©",
        "price": 25,
        "days": 30,
        "profits": "5-10% ÙŠÙˆÙ…ÙŠØ§Ù‹"
    },
    "pro": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©",
        "price": 50,
        "days": 30,
        "profits": "10-15% ÙŠÙˆÙ…ÙŠØ§Ù‹"
    },
    "vip": {
        "name": "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø©",
        "price": 100,
        "days": 30,
        "profits": "15-20% ÙŠÙˆÙ…ÙŠØ§Ù‹"
    }
}

# ==================== Ø¹Ø±Ø¶ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ====================
async def show_subscription_plans(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"""
    try:
        query = update.callback_query
        await query.answer()

        keyboard = []
        for plan_id, plan in SUBSCRIPTION_PLANS.items():
            keyboard.append([
                InlineKeyboardButton(
                    f"{plan['name']} - {plan['price']} USDT",
                    callback_data=f"subscribe_{plan_id}"
                )
            ])

        keyboard.append([InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_main")])
        reply_markup = InlineKeyboardMarkup(keyboard)

        plans_text = "ğŸ’¼ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…ØªØ§Ø­Ø©:\n\n"
        for plan_id, plan in SUBSCRIPTION_PLANS.items():
            plans_text += f"{plan['name']}\n"
            plans_text += f"ğŸ’° Ø§Ù„Ø³Ø¹Ø±: {plan['price']} USDT\n"
            plans_text += f"â³ Ø§Ù„Ù…Ø¯Ø©: {plan['days']} ÙŠÙˆÙ…\n"
            plans_text += f"ğŸ“ˆ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: {plan['profits']}\n\n"

        await query.edit_message_text(plans_text, reply_markup=reply_markup)
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: {e}")
        await send_error_notification(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: {e}")

# ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ====================
async def handle_subscription(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"""
    try:
        query = update.callback_query
        plan_id = query.data.split("_")[1]
        plan = SUBSCRIPTION_PLANS[plan_id]

        await query.answer()

        subscription_text = (
            f"ğŸ‰ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø®Ø·ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!\n\n"
            f"ğŸ”¹ Ø§Ù„Ø®Ø·Ø©: {plan['name']}\n"
            f"ğŸ’° Ø§Ù„Ø³Ø¹Ø±: {plan['price']} USDT\n"
            f"â³ Ø§Ù„Ù…Ø¯Ø©: {plan['days']} ÙŠÙˆÙ…\n"
            f"ğŸ“Š Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: {plan['profits']}\n\n"
            f"ğŸ’¡ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙŠØ±Ø¬Ù‰ Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ§Ù„ÙŠ:\n"
            f"`{WALLET_ADDRESS}`\n\n"
            f"âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©:\n"
            f"â€¢ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙŠØªÙ… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø´Ø¨ÙƒØ© TRC20 ÙÙ‚Ø·\n"
            f"â€¢ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯\n\n"
            f"Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ ÙˆØ£Ø±Ø³Ù„ ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„"
        )

        keyboard = [
            [InlineKeyboardButton("ğŸ“¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø«Ø¨Ø§Øª", callback_data=f"confirm_payment_{plan_id}")],
            [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø®Ø·Ø·", callback_data="subscription_plans")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(subscription_text, reply_markup=reply_markup, parse_mode='Markdown')

        # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ
        user = get_user_data(query.from_user.id)
        user_name = user[1] if user else query.from_user.first_name
        await send_admin_notification(
            f"ğŸ”„ Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯\n"
            f"ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_name}\n"
            f"ğŸ†” Ø§Ù„Ø£ÙŠØ¯ÙŠ: {query.from_user.id}\n"
            f"ğŸ“‹ Ø§Ù„Ø®Ø·Ø©: {plan['name']}\n"
            f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {plan['price']} USDT"
        )
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: {e}")
        await send_error_notification(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: {e}")

# ==================== ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ ====================
async def confirm_payment(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """ØªØ£ÙƒÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹"""
    try:
        query = update.callback_query
        plan_id = query.data.split("_")[2]
        plan = SUBSCRIPTION_PLANS[plan_id]

        await query.answer()
        await query.edit_message_text(
            f"ğŸ“¸ Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø®Ø·Ø© {plan['name']}\n\n"
            f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {plan['price']} USDT\n\n"
            f"ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù†\n\n"
            f"âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©:\n"
            f"â€¢ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ„\n"
            f"â€¢ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡Ø§\n"
            f"â€¢ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„"
        )

        context.user_data['awaiting_payment_proof'] = plan_id
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹: {e}")
        await send_error_notification(f"Ø®Ø·Ø£ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹: {e}")

# ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ ====================
async def handle_payment_proof(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹"""
    try:
        user_id = update.effective_user.id
        user_data = get_user_data(user_id)
        user_name = user_data[1] if user_data else update.effective_user.first_name

        if 'awaiting_payment_proof' in context.user_data:
            plan_id = context.user_data['awaiting_payment_proof']
            plan = SUBSCRIPTION_PLANS[plan_id]

            await update.message.reply_text(
                "âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø«Ø¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\n\n"
                "â³ Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ...\n"
                "Ø³ÙŠØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø± Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰"
            )

            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ø¯Ù…Ù†
            app = Application.builder().token(MAIN_BOT_TOKEN).build()

            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
            keyboard = [
                [InlineKeyboardButton("âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data=f"approve_sub_{user_id}_{plan_id}")],
                [InlineKeyboardButton("âŒ Ø±ÙØ¶ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data=f"reject_sub_{user_id}")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            caption = (
                f"ğŸ“¨ Ø¥Ø´Ø¹Ø§Ø± ØªØ­ÙˆÙŠÙ„ Ø¬Ø¯ÙŠØ¯\n"
                f"ğŸ‘¤ Ù…Ù†: {user_name}\n"
                f"ğŸ†” Ø§Ù„Ø£ÙŠØ¯ÙŠ: {user_id}\n"
                f"ğŸ“‹ Ø§Ù„Ø®Ø·Ø©: {plan['name']}\n"
                f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {plan['price']} USDT"
            )

            await app.bot.send_photo(
                chat_id=ERROR_CHANNEL,  # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
                photo=update.message.photo[-1].file_id,
                caption=caption,
                reply_markup=reply_markup
            )

            del context.user_data['awaiting_payment_proof']

        else:
            await update.message.reply_text("âŒ Ù„Ù… ØªØ·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø®Ø·Ø© Ø£ÙˆÙ„Ø§Ù‹")
    except Exception as e:
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
        await send_error_notification(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ±Ø© Ø§Ù„Ø¯ÙØ¹: {e}")


